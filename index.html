<!DOCTYPE html>
<html>

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">

        <!-- Bootstrap core CSS -->
        <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom fonts for this template -->
        <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i" rel="stylesheet">

        <!-- Custom styles for this template -->
        <link href="css/resume.css" rel="stylesheet">

        <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/0A478A80-E68D-2643-BA05-9F59C9FA973C/main.js" charset="UTF-8"></script><link rel="stylesheet" crossorigin="anonymous" href="https://gc.kis.v2.scr.kaspersky-labs.com/C379AF9C95F9-50AB-3462-D86E-08A874A0/abn/main.css"/>

        <center>
            <h1>IPsec - Segurança na Camada de Rede</h1>
            <h3>Felipe Ferreira, Silvia Caroline, William Macedo</h3>
            <h4>Redes de Computadores I - 2018.1</h4>
            <h4>Engenharia Eletrônica e de Computação</h4>
            <h4>Departamento de Engenharia Eletrônica</h4>
        </center>
    </head>

    <body id="page-top">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
                <a href="#page-top">
                    <img src="img/ipseclogo.png" style="width:300px;">
                </a>

                <!--button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon">IPsec</span>
                </button-->

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav" class="nav-link js-scroll-trigger" href="#intro">1. Introdução</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav" class="nav-link js-scroll-trigger" href="#conceitos">2. Conceitos Básicos</a>
                                <ul>
                                    <li><a class="nav" class="nav-link js-scroll-trigger" href="#criptografia">2.1. Criptografia</a></li>
                                    <li><a class="nav" class="nav-link js-scroll-trigger" href="#fhash">2.2. Funções Hash criptográticas</a></li>
                                    <li><a class="nav" class="nav-link js-scroll-trigger" href="#autenticacaoMsg">2.3. Código de Autenticação de Mensagem</a></li>
                                    <li><a class="nav" class="nav-link js-scroll-trigger" href="#assinatura">2.4. Assinatura Digital</a></li>
                                </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav" class="nav-link js-scroll-trigger" href="#ipsec">3. Arquitetura</a>
                                <ul>
                                    <li><a class="nav" class="nav-link js-scroll-trigger" href="#ha">3.1. Cabeçalho de Autenticação</a></li>
                                    <li><a class="nav" class="nav-link js-scroll-trigger" href="#esp">3.2. Encapsulamento de Dados de Segurança</a></li>
                                    <li><a class="nav" class="nav-link js-scroll-trigger" href="#as">3.3. Associações de Segurança</a></li>
                                    <li><a class="nav" class="nav-link js-scroll-trigger" href="#ike">3.4. Internet Key Exchange</a></li>
                                    <li><a class="nav" class="nav-link js-scroll-trigger" href="#modos">3.5. Modos de Operação</a></li>
                                    <ul>
                                        <li><a class="nav" class="nav-link js-scroll-trigger" href="#mtransporte">3.5.1. Transporte</a></li>
                                        <li><a class="nav" class="nav-link js-scroll-trigger" href="#mtunel">3.5.1. Túnel</a></li>
                                    </ul>
                                </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav" class="nav-link js-scroll-trigger" href="#finais">4. Considerações Finais</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav" class="nav-link js-scroll-trigger" href="#referencias">5. Referências</a>
                        </li>
                    </ul>
                </div>
        </nav>

        <div>
            <h2 id="intro">
                1. Introdução
            </h2>

            <p>A Internet, na sua concepção, foi projetada de forma a ser a mais simples e genérica
              possível, possibilitando assim a sua rápida expansão e crescimento. Toda essa simplicidade é, de fato,
              percebida na facilidade de desenvolvimento e integração entre diversas redes e usuários. Contudo, grandes
              modificações no kernel da Internet não são possíveis de serem feitas. Dessa forma, projetos atuais
              que levam em consideração requisitos que não foram inicialmente pensados na origem da Internet,
              como por exemplo a Segurança da Informação, se utilizam de protocolos adicionais
              para garantirem as suas implementações de forma satisfatória .</p>

              <p>Com o avanço da Globalização, grandes volumes de dados sensíveis trafegam diariamente por todo o
              planeta através da Internet, como operações bancárias e dados governamentais. Começou-se a pensar,
              então, em métodos para evitar que tais informações fossem capturadas indevidamente.</p>

              <p>O protocolo de Internet (IP) versão 6 (IPv6), quando em desenvolvimento, tinha como principais
              objetivos a expansão do número possível de hosts e aumentar a segurança na camada de Rede. Percebeu-se
              então, que estas técnicas de segurança também poderiam ser aplicadas ao IPv4, que é largamente difundido
              e utilizado, além de que sua substituição pelo IPv6 está se dando a passos lentos. </p>

              <p>O principal protocolo de segurança desenvolvido foi o Protocolo de Segurança da Internet (IPsec). Sua maior vantagem
              é o fato de prover comunicação segura, ponto-a-ponto, para diferentes aplicações, de forma transparente
              (operando na camada de Rede, como detalharemos a seguir), tanto para o remetente, quanto para o destinatário.
              Além disso, as aplicações que utilizam IPsec, não precisam ser modificadas de nenhuma forma. Isso é particularmente
              importante, quando se trabalha na segurança de um determinado serviço, porém não se possui o seu código fonte,
              fato bem comum atualmente. </p>

              <p>Entrando no âmbito de quantificar e qualificar a segurança do tráfego de informações, <b>três quesitos</b> se fazem
              presentes: Integridade, Autenticidade e Confiabilidade dos pacotes que trafegam em uma determinada infraestrutura
              de rede, seja ela privada, como por exemplo uma VPN, ou não. Para atender tais requisitos, o protocolo IPsec integra
              sistemas de autenticação, gerenciamento e distribuição de chaves. </p>

              <p>Veremos nas seções seguintes, os conceitos fundamentais que estão embutidos em uma comunicação segura pela rede (como
              criptografia e autenticação), quais protocolos estão embutidos no IPsec, como o datagrama original é alterado e detalhes
              sobre a Arquitetura do protocolo e seus modos de operação. </p>
        </div>

        <div>
            <h2 id="conceitos">
                2. Conceitos Básicos
            </h2>

            <p>Como este texto refere-se a camada de rede, trabalha-se com apenas dois tipos de entidade: hospedeiro e
            roteador. Portanto, a menos que seja explicitado, quando fala-se em <b>entidade</b>, subentende-se que
            trata-se de qualquer uma das entidades da camada de rede.</p>

            <p>Considerando que duas entidades queriam se comunicar de forma segura através de um meio público como a
            Internet, algumas propriedade são desejáveis, conforme indicado em [KUROSE]:</p>

            <ul>
                <li><b>Confidencialidade</b> - apenas remetente e destinatário tem acesso a mensagem descodificada</li>
                <li><b>Integridade da Mensagem</b> - Confiança de que a mensagem não foi alterada durante a transmissão</li>
                <li><b>Autenticação de Ponto Final</b> - Remetente deve confirmar a identidade do destinatário e vice-versa</li>
                <li><b>Segurança Operacional</b> - O ambiente em que a mensagem é escrita deve estar bem protegido. Esta
                    característica não envolve o IPsec, e está além do escopo deste trabalho. Porém, é característica
                    fundamental de uma comunicação segura.</li>
            </ul>

            <h3 id="criptografia">
                2.1. Criptografia
            </h3>

            <p>Uma mensagem sem codificação, tem seu conteúdo em texto plano (também conhecido como texto claro ou aberto).
            Uma mensagem que passa por um algoritmo de criptografia passa a ter um conteúdo em texto cifrado, inteligível
            para um interceptor na transmissão.</p>

            <p>Técnicas e algoritmos de transmissão são publicados e padronizados na Internet (por exemplo as RFCs 1321, 3447, 2420).
            Independente da técnica usada, uma mensagem criptografada só pode ser descriptografada com uma <b>chave de
            segurança</b>. Esta chave (que pode ser a mesma para ambos ou exclusiva de cada um) serve de parâmetro para que o
            algoritmo de decriptação possa transformar a mensagem em texto cifrado em uma mensagem em texto plano. A figura
            2.1.1 ilustra os componentes básicos de um sistema de criptografia.</p>

            <figure>
                <img src="img/criptografia.png">
                <figcaption>Figura 2.1.1 - Esquema geral de uma comunicação criptografada que é interceptada por um invasor.
                Adaptada de [<a href="#KUROSE">1</a>].</figcaption>
            </figure>

            <h3 id="fhash">
                2.2. Funções de Hash criptográficas
            </h3>

            <p>Funções hash criptográficas são usadas para atender a propriedade de integridade da mensagem em uma
            comunicação segura, pois garante-se que a mensagem não foi alterada no meio do caminho.</p>

            <p>Se diferem das funções hash comuns por serem funções bijetoras, ou seja, sempre há um único hash para a
            mensagem escrita. Em outras palavras um invasor não consegue reproduzir o mesmo hash desconhecendo a mensagem
            em texto plano. Algoritmos de hash criptografados bem conhecidos são o MD5[RFC 1321] e o SHA-1[FIPS, 1995].</p>

            <h3 id="autenticacaoMsg">
                2.3. Código de Autenticação de Mensagem
            </h3>

            <p>Nos cenários descritos, ainda é possível q o invasor crie uma mensagem qualquer, gere um hash válido e envie
            para um receptor, falsificando sua identidade como remetente.</p>

            <p>Portanto, emissor e receptor compartilham um segredo chamado de chave de autenticação de mensagem. Essa chave
            é uma sequência de bits que é concatenada à mensagem original para o cálculo da função hash criptográfica.
            O receptor, que possui o código de autenticação, calcula o hash da mensagem recebida concatenada de seu código.
            Se o valor do hash recebido for igual ao do hash calculado, a mensagem é autêntica. A figura 2 ilustra esse
            processo.</p>

            <figure>
                <img src="img/mac.png">
                <figcaption>Sistema de empregando o código de autenticação de mensagem para garantir
                a integridade da mensagem (imagem adaptada de [<a href="#KUROSE">1</a>])</figcaption>
            </figure>

            <h3 id="assinatura">
                2.4. Assinatura Digital
            </h3>

            <p>Têm-se até aqui, garantias de confidencialidade e integridade. Resta identificar um usuário. Ou seja,
            garantir que aquela mensagem válida foi enviada pelo usuário X e somente ele poderia ter enviado essa mensagem.
            Neste caso, uma alternativa é usar um par de chaves (uma pública e uma privada). A chave pública conhecida por
            todos, inclusive pelo destinatário. O remetente "assina" sua mensagem utilizando sua chave privada no hash citado
            na seção 2.2. O destinatário utiliza a chave pública do remetente para chegar ao hash da mensagem e utiliza a
            mensagem para chegar ao hash da mensagem (como explicado na seção 2.3). Caso o valor obtido nos dois processos
            seja o mesmo, o remetente está identificado.</p>
        </div>

        <div>
            <h2 id="ipsec">
                3. Arquitetura do IPsec
            </h2>

            <p>O Protocolo de Segurança da Internet (mais conhecido por sua sigla, IPsec) é um modelo de comunicação
            segura de ponta a ponta através da Internet. Por ser implementado junto ao Protocolo da Internet (IP) na
            camada de rede, é um sistema de segurança transparente às outras camadas da pilha de protocolos, ou seja,
            o IPsec não prejudica o suporte já oferecido pelo IP aos diversos protocolos das camadas de transporte
            e enlace. Inicialmente desenvolvido para IPv6 (a sexta versão do protocolo de internet), foi adaptado para
            ser compatível com IPv4 devido ao lento crescimento do primeiro.

            <p>Foi desenvolvido pela Força-Tarefa de Engenharia da Internet (IETF), um grupo aberto e internacional
            que desenvolve e promove padrões para a Internet. Todos os padrões e protocolos publicados encontram-se
            organizados em documentos técnicos conhecidos como RFCs ("Pedidos de Comentários", em tradução livre).</p>

            <p>A aplicação mais comum do IPsec é em Redes Privadas Virtuais (VPNs), um serviço de tunelamento que garante
            integridade e sigilo de informações enviadas pela Internet. Existem diferentes tipos de VPNs, implementadas
            com alternativas ao IPsec, como os protocolos SSL/TLS, PPTP e L2TP. <font color='red'>PÔR NOTA DE "RODAPÉ?"</font></p>

            <p>No exemplo da figura 3.1, retirado de [KUROSE], a sede de uma instituição qualquer se comunica com sua filial através
            da Internet. Seu roteador com suporte a IPsec, criptografa a mensagem (carga útil) e adiciona um cabeçalho IPsec,
            que será usado pelo Roteador da filial para descriptografar o datagrama. Um cliente remoto (hospedeiro) também
            pode utilizar de uma VPN para se comunicar seguramente com a filial.</p>

            <p>É interessante notar na figura como o IPsec é transparente tanto para a os roteadores da Internet, que enxergam
            a mensagem como um datagrama comum com um cabeçalho IP roteável, quanto para os dispositivos na redes locais,
            que recebem e enviam pacotes descriptografados.</p>

            <figure align="center">
                <img src="img/vpn.png">
                <figcaption>
                    Figura 3.1: Rede Virtual Privada (VPN). Adaptado de [<a href="#KUROSE">1</a>].
                </figcaption>
            </figure>

            <p>O IPsec utiliza três protocolos para cumprir sua função:
                <ul>
                    <li><b>Cabeçalho de Autenticação</b> (AH), que provê autenticação e integridade.</li>
                    <li><b>Encapsulamento de Dados de Segurança</b> (ESP), que provê além de confidencialidade, além de
                        autenticação e integridade.
                    </li><b>Troca de Chaves da Internet</b> (IKE), que auxilia os protocolos acima estabelecendo um canal
                    seguro para a troca de chaves entre remetente e destinatário.
                </ul>

            <p> Vale citar os principais algoritmos de criptografia e autenticação AES128, MD5 e SHA1, todos usados e combinados
            pelos protocolos de segurança listados acima.</p>

            <p>A figura abaixo ilustra o sistema IPsec. A comunicação se inicia com uma conexão lógica, definida pelo protocolo
            IKE e chamada de Associação de Segurança IKE ou simplesmente SA IKE (não confundir com a Associação de Segurança
            do IPsec, que será explicada com detalhes mais a frente. Na RFC 7296, a SA do IPsec é definida como "Child SA").
            Na SA IKE acontecem <i>requisições</i> e <i>respostas</i>. São trocadas informações de controle e chaves
            Diffie-Hellman (ver <a href="#ike">3.4</a>) que servirão para estabelecer outra conexão lógica, a SA
            do IPsec. Nesta SA, é negociada a criptografia da mensagem e outras políticas de segurança.
            Em outras palavras, para que as parte de uma comunicação criptografada se entendam, é preciso uma troca de
            informações prévia. Em outras palavras, antes de se ter uma conversa em código, é preciso combinar o código.</p>

            <p>Todas as informações trocadas são guardadas em bancos de dados nomeados SPD (Banco de Dados de políticas
            de segurança) e SPA (Banco de Dados de Associações de Segurança). Esses bancos são sempre consultados pela
            entidade para que ela saiba como manipular um datagrama IPsec (ver <a href="#sa">3.3</a>). Com as regras
            estabelecidas e banco de dados consultados ou atualizados, é usado um dos protocolos (AH ou ESP) ou ambos.
            Uma vez que o ESP provê as mesmas funcionalidade do AH, o segundo tem caído em desuso.</p>

            <figure align="center">
                <img src="img/estrutura-geral.png" style="width:60%">
                <figcaption>
                    Figura 3.2: Estrutura Geral do IPsec. Adaptada de [<a href="#ALSHAMRANI">11</a>].
                </figcaption>
            </figure>

            <p>Alguns ataques que são evitados com o uso dos protocolos IPsec são:</p>

            <ul>
                <li>Ataques de repetição: um atacante que tem acesso a um fluxo de datagramas injeta datagramas
                modificados. Com o IPsec, os datagramas possuem um digito verificador de sequência e um
                algoritmo anti-repetição.</li>
                <li>Particionamento de pacotes cifrados: o atacante obtém partes de pacotes cifrados
                e monta um pacote que pode ser aceito pelo destinatário. Existem campos no cabeçalho
                IPsec que verificam a integridade do pacote</li>
                <li>"Sniffer": quando o atacante obtém os pacotes que trafegam na rede em texto plano, obtendo
                informações que podem ser sigilosas. No IPsec, é possível criptografar as mensagens. Mesmo que
                um atacante obtenha os pacotes, não terá acesso a informação, pois a mensagem encontra-se cifrada.</li>
            </ul>

            <h3 id="ha">
                3.1. Cabeçalho de Autenticação
            </h3>

            <p>O Cabeçalho de Autenticação (AH) é um protocolo que provê integridade e autenticidade de uma
            mensagem. O datagrama original é modificado, ganhando um cabeçalho de autenticação que possui os campos
            vistos na figura 3.1.1. </p>

            <p>As informações contidas em cada campo do cabeçalho de autenticação (figura <a href="#esp-vs-ah">3.2.1</a>) são listadas abaixo:</p>

            <ul>
                <li>Próximo Cabeçalho: Campo de 8 bits que indica o tipo de pacote (carga útil) subsequente ao cabeçalho
                de autenticação. Sendo o cabeçalho AH um cabeçalho da camada de rede, o cabeçalho subsequente pertence
                a um protocolo da camada imediatamente superior, o que no modelo TCP/IP é a camada de transporte. Neste caso
                o próximo cabeçalho poderia ser TCP ou UDP (cada cabeçalho possui um digito correspondente, que o representa
                neste campo. O protocolo TCP por exemplo, é representado pelo dígito 8).</li>
                <li>Tamanho do Cabeçalho: Campo de 8 bits que especifica o tamanho do cabeçalho AH</li>
                <li>Reservado: Campo de 16 bits reservados para atualizações futuras. Atualmente é preenchido com zeros.</li>
                <li>SPI: O Índice de Parâmetros de Segurança é um campo de 32 bits usado pelo receptor para identificar
                a SA do datagrama recebido.</li>
                <li>Número de Sequência: Campo de 32 bits usado para identificar o datagrama e proteger o receptor de
                ataques de repetição.</li>
                <li>Valor Verificador de Integridade: É utilizado para verificar a integridade e autenticidade do datagrama.
                Como é gerado a partir da encriptação da carga útil, tem tamanho variável e, portanto, possui um enchimento
                para ser múltiplo de 32 bits. Sem cálculo leva em consideração o cabeçalho IP.
                </li>
            </ul>

            <!-- <figure align="center">
                    <img src="img/headerah.png" style="width:400px">
                    <figcaption>
                        Figura 3.1.1:  Campos do Cabeçalho de Autenticação. Adaptado de [FRIEDL].
                    </figcaption>
            </figure> -->

            <!--figure align="center">
                <img src="img/ah.png" style="width:400px">
                <figcaption>Figura 3.3:  Datagrama com Cabeçalho de Autenticação. Adaptado de [RICCI]</figcaption>
            </figure-->

            <p>O AH não oferece confidencialidade. <font color=red>O algoritmo de
            hashing é responsável por criar o ICV. Ao realizar um hash das partes do cabeçalho de IP e das partes dos dados
            do pacote, somente os dados do cabeçalho serão utilizados, por serem incorporados somente no cabeçalho e não
            serem identificados até que sejam calculados.</font></p>

            <p>O destinatário autentica o emissor através de uma assinatura digital, conforme discutido na seção
            <a href="#assinatura">2.4</a>.</p>

            <h3 id="esp">
                3.2. Encapsulamento de Dados de Segurança
            </h3>

            <p>O protocolo ESP oferece integridade, autenticação e sigilo. A autenticação do ESP é diferente da realizada
            pelo AH, pois não inclui o cabeçalho IP, apesar de encapsulá-lo no Modo Túnel (ver <a href="#mtunel">3.5.1</a>).
            O AH protege parte do cabeçalho IP, campos não mutáveis que não são modificados pelos roteadores do meio do
            caminho.</p>

            <p>O campos do cabeçalho ESP são análogos aos do AH, com as seguintes ressalvas: </p>

            <ul>
                <li><b>Enchimento</b> (SPI): Campo com tamanho entre 0 a 255 bytes. Permite a utilização de
                algoritmos de criptografia em blocos, dividindo o datagrama em blocos e enchendo estes para que
                tenham tamanho múltiplo do tamanho definido pelo algoritmo.</li>
                <li><b>Tamanho do Enchimento</b>: Campo de 8 bits que indica o tamanho do enchimento usado na
                operação acima.</li>
                <li><b>Próximo Cabeçalho</b>: Se difere do AH por apontar para trás, pois o campo é lido após
                a carga útil (ver figura 3.2.1).</li>
                <li><b>Valor Verificador de Integridade</b> (ICV): Semelhante ao do AH, porém, seu cálculo não
                leva em conta o cabeçalho IP.</li>
            </ul>

            <figure id="esp-vs-ah" align="center">
                    <img src="img/esp-vs-ah.png" style="width:100%">
                    <figcaption>
                        Figura 3.2.1:  Comparação entre os cabeçalhos AH (esquerda) e ESP (direita). Notar a direção
                        para a qual o campo próximo cabeçalho aponta. Vale citar que a carga útil NÃO faz parte do cabeçalho.
                        Adaptada de [<a href="#FRIEDL">13</a>]
                    </figcaption>
            </figure>

            <h3 id="as">
                3.3. Associações de Segurança
            </h3>

            <p>Antes que seja possível o envio de datagramas, remetente e destinatário estabelecem uma conexão lógica na
            camada de rede, chamada <b>Associação de Segurança</b> (SA). Esta conexão é unidirecional, ou seja, caso duas
            entidades necessitem trocar datagramas IPsec, duas SAs serão necessárias (uma para cada direção), como ilustra
            a figura <a href="#sa-pic">3.3.1</a>. É importante notar neste ponto que uma mesma entidade pode gerenciar
            diversas SAs, mantendo comunicações seguras, com diferentes entidades. Uma SA contém informações sobre origem
            e destino de um datagrama, o tipo de criptografia a ser usada a chave de criptografia, o tipo de verificação
            de integridade (seção <a href="#criptografia">2</a>), a chave de autenticação e um índice que identifica a SA
            (Índice de Parâmetros de Segurança - SPI). Para guardar todas essas informações, cada entidade mantém dois
            bancos de dados, o de políticas de segurança (SPD) e o de SAs (SAD).</p>

            <figure id="sa-pic" align="center">
                <img src="img/sa.png" style="width:50%">
                <figcaption>
                    Figura 3.3.1: Uma ilustração da conexão lógica e unidirecional conhecida por SA.
                    Adaptada de [<a href="#CAMILO">10</a>]
                </figcaption>
            </figure>

            <p>O SAD é consultado pelo remetente quando este precisa enviar um datagrama de acordo com o estabelecido
            previamente com o emissor. O SAD provê o SPI, as chaves e os algoritmos que citamos anteriormente. O SAD
            diz ao emissor como construir o datagrama IPsec que esperado pelo receptor.</p>

            <p>O SPD funciona como uma espécie de firewall. Ele identifica os datagramas pelo remetente, destinatário e
            tipo de protocolo de transporte (UDP, TCP, ICMP, etc) e especifica se devem ser convertidos em datagramas IPsec,
            ou não. Caso o sejam, consultam o SAD. Também especifica quais datagramas devem ser descartados, quais devem ser
            encaminhados ou aceitos mesmo sem proteção IPsec. </p>

            <p>"De certa forma, as informações em um SPD indicam 'o que' fazer com um datagrama que está chegando; as
            informações no SAD indicam 'como' fazer isso"[<a href="#KUROSE">1</a>]</p>

            <p>Naturalmente, as informações que circulam pela SA são também sensíveis e precisam ser protegidas. Para isso,
            o IPsec se utiliza de outro protocolo, o IKE, responsável por gerar segredos, chaves de segurança, dígitos
            Diffie-Hellman (que são especialmente úteis para adicionar segurança à SA do IKE). A justificativa para as duas etapas
            preliminares de negociação, é que o processo realizado pelo IKE é custoso e, portanto, só deve ser realizado uma vez.
            Assim, entidades podem estabelecer diversas SAs IPsec (menos custosas computacionalmente) ao custo de apenas uma SA IKE.
            Mais detalhes serão dados na seção a seguir.</p>

            <h3 id="ike">
                3.4. Internet Key Exchange
            </h3>

            <p>A Internet Key Exchange (IKE) protocolo de gestão de chaves que usa a porta 500 UDP, cria, elimina e altera
            as chaves para autenticação e validação de informações, o IKE caracteriza como regras de gestão do protocolo
            hibrido, constituído pelo ISAKMP e pelo Oakley, sendo denominado IKE. Cria-se uma SA no IPsec para negociar
            politicas de segurança e organizar as trocas das chaves de sessão. </p>

            <p>O IKE (Internet Key Exchange) supre o gerenciamento da segurança para a SA. Na conexão do
            IPsec o IKE autentica cada ponto do host, gateway e servidores, negociando politicas de segurança e manipulando
            as trocas das chaves de sessão. Além disso, usa-se certificados X509v3 para a autenticação dos equipamentos
            envolvidos durante a negociação do IKE. Permissão para comunicação com uma Autoridade Certificadora (CA), gerencia 
            os certificados incluindo o uso do SCEP (Simple Certificate Enrollment Protocol).
            O certificado suporta uma estrutura hierárquica para o uso em uma infraestrutura de chaves públicas (PKI).</p>

            <p>Os componentes incluídos são os protocolos de chaves públicas Diffie-Hellman estabelecendo uma chave de sessão
            mesmo estando em um meio inseguro, que é a Internet.</p>

            <p>IKE mune quatro funcionalidades:</p>

            <ul>
                <li>Negocia quais protocolos, algoritmos e chaves serão usadas.</li>
                <li>Garantir a identidade das partes, o cliente, quanto do servidor.</li>
                <li>Gerencia as chaves após elas estarem em uso.</li>
                <li>Garante que as trocas de mensagens que contém chaves sejam feitas por meios seguros.</li>
            </ul>

            <p>A configuração de uma SA pode ser feita manualmente em cada gateway por um administrador de segurança,
            sendo alterada também pelo protocolo IKE dinamicamente, sendo assim, garantindo uma segurança ainda maior.</p>

            <p>A gerencia de chaves é especificada pelo IPsec sendo implementada de modo manual ou automática. E o protocolo
            IKE é responsável por implementar a gerência automática de chaves. O ISAKMP é o executor do estabelecimento,
            negociação, modificação e exclusão das AS’s. Definindo o formato dos pacotes e os procedimentos. O OAKLEY
            fornece o mecanismo de troca de chaves utilizado pelo ISAKMP. Sendo uma variação mais segura do algoritmo
            Diffie-Hellman.</p>

            <p>Para estabelecer uma associação segura IKE, a negociação deve ser feita pelo o modo propondo os seguintes itens:</p>
                <li>O algoritmo de criptografia para proteger os dados;</li>
                <li>Um algoritmo de hash para assinatura digital;</li>
                <li>Um método de autenticação para assinar o hash; </li>
                <li>Informação sobre qual grupo a troca Diffie-Hellman deve feita; </li>
                <li>Especificação da função pseudorrandômica para fazer o hash de certos.</li>
            </ul>

            <p>O IKE procede em duas fases. Na primeira fase, dois pares estabelecem um canal seguro para efetuar as operações do
            ISAKMP SA. Na segunda fase, os dois pares ajustam os SA de um plano geral.</p>

            <h3 id="modos">
                3.5. Modos de Operação
            </h3>
            <p>O IPsec apresenta dois modos de funcionamentos: o Modo Transporte e o Modo Túnel.</p>

            <p>O terceiro protocolo é o IKE, sua função é realizar a autenticação das
            entidades envolvidas e gerir automaticamente as ligações IPsec. O Transporte IPsec trabalha em dois modos, modo
            de Transporte e modo Túnel. No modo de Transporte, apenas o segmento da camada de transporte é processado, ou
            seja, autenticado e criptografado. Este modo é adequado para implementações em servidores e gateways, protegendo
            camadas superiores de protocolos, além de cabeçalhos IP selecionados. O cabeçalho AH é implantado após o
            cabeçalho IP e antes do protocolo de camada superior; TCP, UDP e ICMP, ou antes de outros cabeçalhos que o IPsec
            tenha inserido. Na abertura para modificações os endereços de IP de origem e destinos caso os pacotes sejam
            interceptados.</p>

            <p>Assegurando a segurança apenas dos dados oriundos das camadas superiores está o modo transporte que é empregado
            para comunicação fim-a-fim entre computadores. Para conceder a segurança para a camada IP o modo túnel é aplicado
            para comunicação entre roteadores. Sendo assim, ambos os protocolos AH e ESP podem funcionar no modo transporte e
            túnel.</p>

            <figure align="center">
                    <img src="img/modos.png" style="width:700px">
                    <figcaption>
                        Figura 3.3.1:  Estrutura de um datagrama IPsec nos diferentes modos
                    </figcaption>
            </figure>

            <h4 id="mtransporte">
                3.5.1. Transporte
            </h4>

            <p>O Modo Transporte é utilizado para estabelecer ligações seguras entre hosts. Neste modo é mantido
            o header original dos pacotes IP e apenas as informações das camadas superiores são protegidas. Os
            hosts precisão aguentar a funcionalidade IPsec.</p>

            <p>No Modo Transporte o protocolo AH efetiva o pacote dos dados do pacote IP original a sua autenticação
            e integridade. Mantem-se o IP header original e insere o header do protocolo AH para a proteção.</p>

            <figure align="center">
                    <img src="img/ah-transporte.png" style="width:65%">
                    <figcaption>
                        Figura 3.3.1:  Estrutura de um datagrama IPsec nos diferentes modos
                    </figcaption>
            </figure>

            <p>O protocolo ESP gera autenticação, integridade e confidencialidade encriptação da carga útil do pacote IP
            original no modo transporte. Mantem-se o IP header original, insere o header e o trailer do protocolo ESP
            para a proteção. Necessitando assim suporte ao IPsec o emissor e receptor da comunicação. Protegendo apenas
            os cabeçalhos superior, o cabeçalho IP mantém-se original, pois o cabeçalho IPsec é adicionado imediatamente
            após o cabeçalho IP, antes dos cabeçalhos dos protocolos das camadas superiores.</p>

            <p>Os dados são criptografados e assinados no cabeçalho ESP, no cabeçalho de transporte e dados e o trailer
            de ESP, quando a criptografia e autenticação são selecionadas, sendo assim, a criptografia é realizada
            primeira.</p>

            <figure align="center">
                    <img src="img/mtransporte-esp.png" style="width:100%">
                    <figcaption>
                        Figura 3.3.1:  Protocolo ESP no modo transporte
                    </figcaption>
            </figure>

            <h4 id="mtunel">
                3.5.2. Túnel
            </h4>

            <p>O pacote IP no modo túnel é autenticado ou criptografado, tornando apenas o cabeçalho IP externo visível,
            transmitindo o destino do gateway roteador, firewall, subsistindo todo o conteúdo interno criptografado.
            Pode-se usar desse método para evitar a análise de tráfego devido ao fato de que o cabeçalho IP contém o
            endereço de destino e teoricamente as diretivas de roteamento e informação proveniente da opção salto-a-salto,
            sendo impossível transmitir o pacote IP criptografado dispondo prefixo de cabeçalho ESP, pois roteadores
            intermediários seriam incapazes de processar o pacote.</p>

            <p>Será fundamental encapsular o bloco inteiro do cabeçalho ESP mais o pacote IP criptografado com um novo
            cabeçalho IP que deverá conter informações para o roteamento, não terá que ter análise de tráfego. No modo
            de transporte é adequado para proteger conexões entre estações que suportam o modo ESP. O modo túnel é
            utilizável numa configuração que apresente um firewall ou outro tipo de gateway de segurança que protege
            uma rede confiável das redes externas. Na proteção de uma rede confiável, a criptografia ocorre apenas entre
            uma estação externa e o gateway de segurança, ou entre dois gateways de segurança. Permitindo as estações
            da rede interna do processamento de criptografia e resumindo a tarefa do número de chaves pela redução do
            numero de chaves necessárias de distribuição e inibindo a análise de tráfego baseada no destino final.</p>

            <p>O protocolo AH realizada autenticação e integridade de todo o pacote IP original. Um novo IP header e o
            header do protocolo é inserido no AH para a proteção. O IP header original contém os endereços IP de origem e
            destino da mensagem, enquanto o novo IP header contém os endereços IP dos gateways IPsec.</p>

            <figure align="center">
                    <img src="img/mtunel-ah.png" style="width:70%">
                    <figcaption>
                        Figura 3.3.1:  Protocolo AH no modo túnel.
                    </figcaption>
            </figure>

            <p>O protocolo ESP efetua autenticação, integridade e confidencialidade do pacote IP original. Para proteção
            um ESP trailer é inserido e no ESP herda um novo IP. Enquanto o novo IP header original contém os endereços IP
            dos gateways IPsec, são inseridos nos endereços IPs de origem e destinos.</p>

            <p>No modo túnel, o ESP assinará o cabeçalho de ESP, cabeçalho original de IP, cabeçalho de transporte de dados,
            o trailer de ESP.  A diferença para o modo de transporte está no datagrama de IP original que será́ todo
            criptografado. O Modo Túnel é o mais empregue e serve para criar uma ligação segura VPN entre duas gateways ou
            entre um gateway e um host. No dispositivo utilizado os equipamentos internos não precisam de suportar o IPsec,
            a encriptação e desencriptação ocorre nas IPsec gateways. Um novo IP header é criado e o pacote IP original é
            totalmente protegido.</p>

            <figure align="center">
                    <img src="img/mtunel-esp.png" style="width:70%">
                    <figcaption>
                        Figura 3.3.1:  Protocolo ESP no modo túnel.
                    </figcaption>
            </figure>


        </div>

        <div>
            <h2 id="finais">4. Considerações Finais</h2>
        </div>

            <p>O IPsec, conforme pudemos observar, é um protocolo que opera na camada de rede e possibilita uma comunicação
            segura entre dois terminais de rede, sendo segurança equivalente à transferência de pacotes com integridade,
            autenticidade e possível confidencialidade. Vimos que uma comunicação neste protocolo se inicia com o
            estabelecimento de chaves, algoritmos e protocolos que serão utilizados na sessão (SA IKE). Após isso, a associação
            de segurança (SA IPsec) é estabelecida. Os principais métodos de proteção utilizados pelo IPsec são os protocolos AH
            e ESP. O primeiro garante integridade (ou seja, que a mensagem não foi alterada) e autenticidade (garantia da autoria).
            Já o segundo garante também confidencialidade, já que a carga útil trafega cifrada, e não em texto plano.</p>

            <p>Dois modos de operação são possíveis no IPsec. No Modo Transporte, o cabeçalho IP original é mantido (camada de
            transporte) e o resto do pacote é aplicado ao ESP. No Modo Túnel, o cabeçalho IP original é aplicado também ao
            protocolo ESP. Um novo cabeçalho IP é anexado ao datagrama, de forma que o endereço final também está protegido.
            A mesma explicação é válida para o caso de utilizarmos o protocolo AH, ou uma combinação de ambos.</p>

            <p>Concluímos que o IPsec é um protocolo que fornece uma tecnologia poderosa em termos de segurança da informação
            que trafega em uma rede IP. Sua arquitetura permite uma implementação de forma invisível para as camadas inferiores,
            operando de forma transparente. Suas configurações permitem evitar que pessoas má intencionadas monitorem
            o fluxo da informação, ou até se passem pelo autor original da mensagem. É uma arma poderosa contra hackers e
            transforma um ambiente hostil (Internet) em um caminho seguro para o tráfego entre redes de computadores.</p>

        <div>
            <h2 id="referencias">5. Referências</h2>
            <ul>
                <li id="KUROSE">[1] KUROSE, James F. Redes de Computadores e a Internet - Uma abordagem Top-Down, 6ª Edição. Pearson Education Índia, 2014.</li>
                <li id="PERLMAN">[2] PERLMAN, Radia; KAUFMAN, Charlie; SPECINER, Mike. Network security: Private Communication in a Public World, 2ª Edição. Pearson Education Índia, 2016.</li>
                <li id="RFC4301">[3] KENT, S.; SEO, K. RFC 4301 "Security architecture for the internet protocol". Disponível em https://tools.ietf.org/html/rfc4301, 2005.</li>
                <li id="RFC4302">[4] KENT, S. RFC 4302 “IP Authentication Header”. Disponível em http://tools.ietf.org/html/rfc4302, 2005.</li>
                <li id="RFC4303">[5] KENT, S. RFC 4303 "IP Encapsulating Security Payload (ESP)". Disponível em http://tools.ietf.org/html/rfc4303, 2005.</li>
                <li id="RFC6071">[6] FRANKEL, S.; KRISHNAN, S. RFC 6071 "IP Security (IPsec) and Internet Key Exchange (IKE) Document Roadmap". Disponível em https://tools.ietf.org/pdf/rfc6071, 2011.</li>
                <li id="RFC7296">[7] KIVINEN, T., HOFFMAN, P., KAUFMAN, C., NIR, Y., ERONEN, P. RFC 7296 "Internet Key Exchange Protocol Version 2 (IKEv2)". Disponível em https://tools.ietf.org/pdf/rfc7296, 2014.</li>
                <li id="FRANKEL">[8] FRANKEL, S.; KENT, K.; LEWKOWSKI, R.; OREBAUGH, A. D.; RITCHEY, R. W.; SHARMA, S. R. Guide to IPSec VPNs. NIST Special Publication, v. 800, 2005.</li>
                <li id="OPPLIGER">[9] OPPLIGER, R. Security at the internet layer. Computer, v. 31, n. 9, p.43{47, 1998.</li>
                <li id="CAMILO">[10] CAMILO, B. D. C. V. Análise da sobrecarga do ipsec no mapeamento de redes virtuais. 2015. (Projeto Final de Graduação) - Universidade Federal do Rio de Janeiro, 2015.</li>
                <li id="ALSHAMRANI">[11] ALSHAMRANI, H. Internet Protocol Security (IPsec) Mechanisms. International Journal of Scientific & Engineering Research, v. 5, n. 5, p.85{87, 2014.</li>
                <li id="RICCI">[12] RICCI, B. Rede Segura: VPN Linux, 1ª Edição. Ciência Moderna, Rio de Janeiro, 2007.</li>
                <li id="FRIEDL">[13] FRIEDL, S. J. An Illustrated Guide to IPsec. Disponível em http://www.unixwiz.net/techtips/iguide-ipsec.html, acessado em maio de 2018
                <li id="BRAGNETTO">[14] BRAGNETTO, L. F. B., da SILVA, S. C., BARBOSA, L. A. M. IPsec - Segurança de Redes, 2003. Disponível em http://www.braghetto.eti.br/files/IPSec%20-%20Versao%20Final.pdf. Acessado em 18 de maio de 2018.  </li>
                <!--li>[7] FORTIO, R. M. S. Análise e implementação do protocolo de segurança IPsec na rede de acesso LTE. 2014 (Master Thesis) - Técnico Lisboa. 2014</li-->
                <!--li>[2] FERGUSON, N.; SCHNEIER, B. A cryptographic evaluation of IPSec. Counterpane Internet Security, Inc, v. 3031, p. 14, 2000.</li-->
                <!--li>[9] JAMHOUR, E. IPsec. Disponível em: <"https://www.ppgia.pucpr.br/~jamhour/">. Acesso em: 21 maio.2018.</li-->
            </ul>
        </div>

        <hr>
        <footer>
            <p>"Este trabalho foi totalmente produzido pelos autores que declaram não terem violado os direitos autorais
            de terceiros, sejam eles pessoas físicas ou jurídicas. Havendo textos, tabelas e figuras transcritos de obras
            de terceiros com direitos autorais protegidos ou de domínio público tal como ideias e conceitos de terceiros,
            mesmo que sejam encontrados na Internet, os mesmos estão com os devidos créditos aos autores originais e estão
            incluídas apenas com o intuito de deixar o trabalho autocontido. O(s) autor(es) tem(êm) ciência dos Artigos 297
            a 299 do Código Penal Brasileiro e também que o uso do artifício de copiar/colar texto de outras fontes e outras
            formas de plágio é um ato ilícito, condenável e passível de punição severa. No contexto da Universidade a punição
            não precisa se restringir à reprovação na disciplina e pode gerar um processo disciplinar que pode levar o(s)
            aluno(s) à suspensão;"</p>
        </footer>
    </body>
</html>
